- name: Build backend (PyInstaller onefile)
  shell: pwsh
  run: |
    python -m pip install --upgrade pip
    pip install -r backend/requirements.txt pyinstaller

    # 固定输出目录，避免找不到 dist/mvp_backend.exe
    pyinstaller --onefile --name mvp_backend backend/backend_server.py --distpath backend/dist --workpath backend/build

    if (!(Test-Path "src-tauri/bin")) { New-Item -ItemType Directory -Force -Path "src-tauri/bin" | Out-Null }

    # 兼容 onefile/onedir 两种可能输出
    $exe1 = "backend/dist/mvp_backend.exe"
    $exe2 = "backend/dist/mvp_backend/mvp_backend.exe"
    if (Test-Path $exe1) { $src = $exe1 }
    elseif (Test-Path $exe2) { $src = $exe2 }
    else {
      Write-Host "backend/dist contents:"
      Get-ChildItem -Recurse "backend/dist" -ErrorAction SilentlyContinue
      throw "mvp_backend.exe not found after PyInstaller"
    }

    Copy-Item $src "src-tauri/bin/mvp_backend.exe" -Force
